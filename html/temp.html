<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/login.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css"/>  <link rel="stylesheet" href="../css/chat.css">
  
</head>
<body>
  <div class="chat-container">
    <div class="header">
        MindX Chat
        <button id="logOut">Log Out</button>
    </div>
    <div class="main">
      <div class="aside-left">
        <div class="create-conversation">
          <button class="btn">+ New conversation</button>
        </div>
        <div class="list-conversations">
          
        </div>
      </div>
      
  
      <div class="conversation-detail">
          <div class="conversation-header">    
          First conversation      
          </div>
          <div class="list-messages" >
            
          </div>
          <form id="send-messenger-form">
            <div class="input-wrapper">
              <input type="text" name="message" placeholder="Type a messenger">
            </div>
            <button type="submit">
              <i class="fa fa-paper-plane" aria-hidden="true"></i>
            </button>
          </form>
      </div>
        
      <div class="aside-right">   
        <div class="list-user">
            <div class="user">Ngohung0999@gmail.com</div>
            <div class="user">Ngohung0999@gmail.com</div>
            <div class="user">Ngohung0999@gmail.commmmmmmmmmmmmmm</div>
        </div>
        <form id="add-user- form">
          <div class="input-wrapper">
            <input type="text" name="email" placeholder="Input friend name">
            <div class="error" id="add-user-email-error"></div>
          </div>
          <button class="btn" type="submit">Add</button>
        </form>
      </div>
    </div>
  </div>
</body>
</html>

const view = {}
view.setActiveScreen = (screenName, fromCreateConversation = false) => {
  switch (screenName) {
    case 'loginScreen' :
    // in ra man login
      document.getElementById('app').innerHTML = components.loginScreen
      document.getElementById('redirect-to-register').addEventListener('click', () => {
        view.setActiveScreen('registerScreen')
      })
      const loginForm = document.getElementById('login-form')
      loginForm.addEventListener('submit', (e) => {
        e.preventDefault()
        loginForm.email.value = loginForm.email.value.trim()
        const dataLogin = {
          email: loginForm.email.value,
          password: loginForm.password.value
        }
        controller.login(dataLogin)
      })
    break;

    case 'registerScreen' :
      document.getElementById('app').innerHTML = components.registerScreen
      const registerForm = document.getElementById('register-form')
      registerForm.addEventListener('submit', (event) => {
        event.preventDefault()
        const dataRegister = {
          firstName: registerForm.firstName.value,
          lastName: registerForm.lastName.value,
          email: registerForm.email.value,
          password: registerForm.password.value,
          confirmPassword: registerForm.confirmPassword.value
        }
        console.log(dataRegister)
        controller.register(dataRegister)
      })
      document.getElementById('redirect-to-login').addEventListener('click', () => {
        view.setActiveScreen('loginScreen')
      })
    break;

    case  'chatScreen' :
      document.getElementById('app').innerHTML = components.chatScreen
      const sendMessengerForm = document.getElementById("send-messenger-form")
      sendMessengerForm.addEventListener("submit",(e)=>{
        e.preventDefault()
      if(sendMessengerForm.message.value.trim() !== ''){
        const message = {
          content :sendMessengerForm.message.value,
          owner : model.currentUser.email,
          createdAt : (new Date()).toISOString()
        }   
        // view.addMessage(message)
        model.addMessage(message)
        sendMessengerForm.message.value = ''
      }
    })
    
    if(!fromCreateConversation){
      model.loadConversations()
      model.listenConversationsChange()
    }else {
      view.showConversations()
      view.showCurrentConversation()
    }
    // Log Out
      document.getElementById("logOut").addEventListener("click", (e) => {
        e.preventDefault()  
        firebase.auth().signOut().then(() => {
          alert("Sign-out successful.")
        })
      })
    //  Sang mÃ n create conversation
        document.querySelector(".create-conversation .btn").addEventListener('click', () =>{
          view.setActiveScreen('createConversation')
        })

    // add  User to the Conversation
    let addUserForm = document.getElementById("add-user-form")
    addUserForm.addEventListener("submit", (e) => {
      e.preventDefault()
      const user =  addUserForm.email.value
      controller.addUserConversation(user)
      addUserForm.email.value = ''
    })
    
    document.querySelector('#send-messenger-form input').addEventListener('click',() => {
      view.hideNotification(model.currentConversation.id)
    })
    break;

    case 'createConversation' :
      // sang man createConversation
      document.getElementById('app').innerHTML = components.createConversation
      document.querySelector('#back-to-chat').addEventListener('click',() =>{
        view.setActiveScreen("chatScreen" , true)
      })
      
      const creatConversationForm = document.getElementById('create-conversation-form')
      creatConversationForm.addEventListener('submit', (e) => {
        e.preventDefault()
        const dataCreateConversation = {
          conversationTitle : creatConversationForm.conversationTitle.value,
          conversationEmail : creatConversationForm.conversationEmail.value,
        }
        controller.createConversation(dataCreateConversation)
      })
    }
}

view.addMessage = (message) => {
    const messageWrapper = document.createElement("div")
    messageWrapper.classList.add('message-container')
    if (message.owner === model.currentUser.email){
      messageWrapper.classList.add("mine")  
        messageWrapper.innerHTML = `
        <div class="content">
          ${message.content}
          </div>
        `        
    }else {
      messageWrapper.classList.add('their')
      messageWrapper.innerHTML = `
        <div class="owner">
          ${message.owner}
        </div>
        <div class="content">
          ${message.content}
        </div>
      `
    }
    document.querySelector(".list-messages").appendChild(messageWrapper)
}

view.showCurrentConversation = () => {
  document.querySelector('.list-messages').innerHTML = ''
  // Doi ten cuoc tro truyen
  // console.log(model.currentConversation)
  document.getElementsByClassName('conversation-header')[0].innerText = model.currentConversation.title
  // In cac tin nhan len man hinh
  for(message of model.currentConversation.messages){
    view.addMessage(message)
  }
  view.scrollToEndElement()
  // in ten nhung nguoi dung trong mes
  view.showListUsers(model.currentConversation.users)
}
view.showListUsers = (users) => {
  document.querySelector('.list-user').innerText = ''
  for(user of users){
    view.addUser(user)
  }
}
view.addUser = (user) => {
  const userWrapper = document.createElement('div')
  userWrapper.classList.add('user')
  userWrapper.innerText = user
  document.querySelector('.list-user').appendChild(userWrapper)
}
view.scrollToEndElement = () => {
  var element = document.querySelector(".list-messages");
  element.scrollTop = element.scrollHeight;
}

view.showConversations = () => {
  for(oneConversation of model.conversations){
    view.addConversation(oneConversation)
  }
}
// hien thi cuoc tro truyen khi click
view.addConversation = (conversation) => {
  const conversationWrapper = document.createElement("div")
  conversationWrapper.className = 'conversation cursor-pointer'
  conversationWrapper.id = conversation.id
  if (model.currentConversation.id === conversation.id){
    conversationWrapper.classList.add('current')
  }
  conversationWrapper.innerHTML = `
    <div class conversation-title>${conversation.title}</div>
    <div class conversation-num-user>${conversation.users.length} user</div>
    <div class="notification"></div>
  `

conversationWrapper.addEventListener('click',() => {
    // doi giao dien current
    document.querySelector('.current').classList.remove('current')
    //them class current khi click vao
    conversationWrapper.classList.add('current')
    // thay doi model.currentConversation
    for (oneConversation of model.conversations){
      if(oneConversation.id === conversation.id){
        model.currentConversation = oneConversation
      }
    }
    // const newConversation =  model.conversations.filter(oneConversation => oneConversation.id = model.currentConversation)
    // in cac tin nhan len man hinh
    view.showCurrentConversation()
    view.hideNotification(conversation.id)
  })
  document.querySelector('.list-conversations').appendChild(conversationWrapper)
}

view.setErrorMessage = (elementId, message) => {
  document.getElementById(elementId).innerText = message
}

view.updateNumberUsers = (docId, numberUsers) => {
  const conversation = document.getElementById(docId)
  // lay phan tu thu  2 trong div
  const secondChild = conversation.getElementsByTagName('div')[1]
  secondChild.innerText  = numberUsers + ' ' + 'users'
}

view.showNotification = (conversationId) => {
  const conversation = document.getElementById(conversationId)
  conversation.lastElementChild.style = 'display : block'
}
view.hideNotification = (conversationId) => {
  const conversation = document.getElementById(conversationId)
  conversation.lastElementChild.style = 'display : none'
}




const model = {}
model.currentUser = undefined;
// load cuoc tro chuyen
model.conversations = undefined;
model.currentConversation = undefined;
// luu lai ten tren fire base
model.collectionName = 'conversations';
model.register = async (data) => {
  try {
    await firebase.auth().createUserWithEmailAndPassword(data.email, data.password)
    firebase.auth().currentUser.updateProfile({
      displayName: data.firstName + ' ' + data.lastName
    })
    firebase.auth().currentUser.sendEmailVerification()
    alert('The email has been registered, please check you email!')
    view.setActiveScreen('loginScreen')
  } catch(err) {
    console.log(err)
    alert(err.message)
  }

    // .then( res => {
    //     firebase.auth().currentUser.updateProfile({
    //         displayName : data.fistName + " " + data.lastName,
    //     })
    //     firebase.auth().currentUser.sendEmailVerification().catch((err) => {
    //         console.log(err)
    //     });
    // });
    
}

model.login = async (dataLogin) => {
    try {
      const response =  await firebase.auth().signInWithEmailAndPassword(dataLogin.email, dataLogin.password)
      console.log(response)
          if (response.user.emailVerified === false){
              document.getElementById('email-error').innerText  = 'Please verify your email'
          }else{
              model.currentUser = {
                  displayName : response.user.displayName,
                  email : response.user.email
              } 
              view.setActiveScreen('chatScreen')
          }
      } catch(err){
          console.log(err)
          if (err.code == 'auth/user-not-found' || err.code == 'auth/invalid-email') {
              document.getElementById('email-error').innerText  = `${err.message}`
          } else if (err.code == 'auth/wrong-password') {
            document.getElementById('password-error').innerText  = `${err.message}`
          }
    }
}

model.addMessage = (message) => {
        const dataToUpdate = {
          messages : firebase.firestore.FieldValue.arrayUnion(message)
        }
        firebase.firestore().collection(model.collectionName).doc(model.currentConversation.id).update(dataToUpdate)
}

model.loadConversations = async () =>{
    const response = await firebase.firestore().collection(model.collectionName).where('users','array-contains', model.currentUser.email).get()
    model.conversations = getDataFromDocs(response.docs)
    // load cuoc tro chuyen dau tien
    if(model.conversations.length > 0){
      model.currentConversation = model.conversations[0]
      view.showCurrentConversation()
    }
    view.showConversations()
}     
// lang nghe thay doi
model.listenConversationsChange  = () => {
  let isFirstRun = true ;
  firebase.firestore().collection(model.collectionName).where('users','array-contains', model.currentUser.email)
  .onSnapshot((res) => {
    if(isFirstRun){
      isFirstRun = false ;
      return 
    }
    // 1 list document su thay doi
    const docChanges = res.docChanges()
    console.log(docChanges)
    for(oneChange of docChanges) {
      const type = oneChange.type
      if(type === 'modified'){
        const docData = getDataFromDoc(oneChange.doc)
        // update lai model.conversation
        for( let index = 0 ;index < model.conversations.length; index++){
          if(model.conversations[index].id === docData.id){
            model.conversations[index] = docData
          }
        }
        if (docData.messages[docData.messages.length - 1].owner !== model.currentUser.email){
          view.showNotification(docData.id)
        }
        // update model.currentConversation
        if(docData.id === model.currentConversation.id){
          if(docData.users.length !== model.currentConversation.users.length){
            view.addUser(docData.users[docData.users.length - 1])
            view.updateNumberUsers(docData.id,docData.users.length)
          }else {
            const lastMessage = docData.messages[docData.messages.length - 1]
            view.addMessage(lastMessage)
            view.scrollToEndElement()
          }
          model.currentConversation = docData
        }
      }
      if(type === 'added'){
        const docData = getDataFromDoc(oneChange.doc)
        model.conversations.push(docData)
        view.addConversation(docData)
      }
    }
  })
}

// add  new conversation
model.createConversation =  (dataCreateConversation) => {
  firebase.firestore().collection(model.collectionName).add(dataCreateConversation)
  view.setActiveScreen('chatScreen',true)  // them true de lang nghe thay doi ko bi add nhieu lan 
}

// add user to the conversation
model.addUser = (user) => {
  const dataToUpdate = {
    users : firebase.firestore.FieldValue.arrayUnion(user)
  }
  firebase.firestore().collection(model.collectionName).doc(model.currentConversation.id).update(dataToUpdate)
}